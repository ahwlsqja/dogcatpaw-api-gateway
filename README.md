# ğŸ¾ ë©ëƒ¥í¬ API Gateway

ë©ëƒ¥í¬(DogCatPaw) í”Œë«í¼ì˜ **ë‹¨ì¼ ì§„ì…ì (Single Entry Point)** ì—­í• ì„ í•˜ëŠ” API Gatewayì…ë‹ˆë‹¤.

í«ì˜ ë¹„ë¬¸(Nose Print)ì„ í™œìš©í•œ **DID(Decentralized Identifier)** ê¸°ë°˜ ì‹ ì› ê´€ë¦¬ ì‹œìŠ¤í…œìœ¼ë¡œ, **Hyperledger Besu** ë¸”ë¡ì²´ì¸ì„ ì‹ ë¢°ì˜ ì›ì²œìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

- [í”„ë¡œì íŠ¸ ê°œìš”](#í”„ë¡œì íŠ¸-ê°œìš”)
- [í•µì‹¬ ê°œë…](#í•µì‹¬-ê°œë…)
- [ì•„í‚¤í…ì²˜](#ì•„í‚¤í…ì²˜)
- [ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µì‹  êµ¬ì¡°](#ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤-í†µì‹ -êµ¬ì¡°)
- [ì¸ì¦ í”Œë¡œìš°](#ì¸ì¦-í”Œë¡œìš°)
- [ë°ì´í„° ë™ê¸°í™” ì „ëµ](#ë°ì´í„°-ë™ê¸°í™”-ì „ëµ)
- [ê¸°ìˆ  ìŠ¤íƒ](#ê¸°ìˆ -ìŠ¤íƒ)
- [ì„¤ì¹˜ ë° ì‹¤í–‰](#ì„¤ì¹˜-ë°-ì‹¤í–‰)
- [API ì—”ë“œí¬ì¸íŠ¸](#api-ì—”ë“œí¬ì¸íŠ¸)
- [í™˜ê²½ ë³€ìˆ˜](#í™˜ê²½-ë³€ìˆ˜)

---

## í”„ë¡œì íŠ¸ ê°œìš”

ë©ëƒ¥í¬ëŠ” ë°˜ë ¤ë™ë¬¼ì˜ **ë¹„ë¬¸(ì½” ë¬´ëŠ¬)**ì„ ìƒì²´ ì¸ì‹ ì •ë³´ë¡œ í™œìš©í•˜ì—¬ **ë¶„ì‚° ì‹ ì›(DID)**ì„ ë°œê¸‰í•˜ê³ , ì´ë¥¼ í†µí•´ ì…ì–‘, ë³´í˜¸ê¶Œ ì´ì „ ë“±ì˜ ì´ë ¥ì„ ë¸”ë¡ì²´ì¸ì— ê¸°ë¡í•˜ëŠ” í”Œë«í¼ì…ë‹ˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥

- **ë¹„ë¬¸ ê¸°ë°˜ ì‹ ì› ì¸ì¦**: ML ì„œë²„ë¥¼ í†µí•´ í«ì˜ ì½” ì´ë¯¸ì§€ì—ì„œ íŠ¹ì§• ë²¡í„°ë¥¼ ì¶”ì¶œí•˜ê³ , ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³ ìœ í•œ Pet DIDë¥¼ ìƒì„±
- **VC/VP ê¸°ë°˜ ì¸ì¦**: W3C DID í‘œì¤€ì„ ë”°ë¥´ëŠ” Verifiable Credential(VC)ê³¼ Verifiable Presentation(VP) ë°œê¸‰
- **ë¸”ë¡ì²´ì¸ ê¸°ë°˜ ì‹ ë¢°**: Hyperledger Besu ë„¤íŠ¸ì›Œí¬ì— í« ë“±ë¡, ë³´í˜¸ì ì—°ê²°, ì´ì „ ì´ë ¥ ê¸°ë¡
- **ëŒ€ë¦¬ ë³´í˜¸ì ì‹œìŠ¤í…œ**: í«ì˜ ì»¨íŠ¸ë¡¤ëŸ¬(ë³´í˜¸ì)ê°€ ì§€ê°‘ ì„œëª…ì„ í†µí•´ VC/VP ë°œê¸‰

---

## í•µì‹¬ ê°œë…

### Pet DID ìƒì„± ê³¼ì •

```
ì½” ì´ë¯¸ì§€ â†’ ML ì„œë²„ â†’ íŠ¹ì§• ë²¡í„° ì¶”ì¶œ â†’ keccak256(vector) â†’ Pet DID
```

### VPì™€ JWT ì„¸ì…˜

- **1 VP = 1 JWT ì„¸ì…˜**: í•˜ë‚˜ì˜ Verifiable Presentationì´ í•˜ë‚˜ì˜ JWT ì„¸ì…˜ìœ¼ë¡œ ì·¨ê¸‰ë©ë‹ˆë‹¤
- ë³´í˜¸ìê°€ ì§€ê°‘ìœ¼ë¡œ VPì— ì„œëª…í•˜ë©´ í”Œë«í¼ ë¡œê·¸ì¸ì´ ì™„ë£Œë©ë‹ˆë‹¤

### ì‹ ë¢°ì˜ ì›ì²œ

```
Hyperledger Besu (ë¸”ë¡ì²´ì¸)
        â†“
    Smart Contracts
    - PetDIDRegistry
    - GuardianRegistry
    - ShelterRegistry
        â†“
    On-chain ìƒíƒœê°€ ëª¨ë“  ì„œë¹„ìŠ¤ì˜ ì§„ì‹¤ì˜ ì›ì²œ
```

---

## ì•„í‚¤í…ì²˜

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚      NCloud Kubernetes Service   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            Ingress                                 â”‚
        â”‚                                                                    â”‚
        â”‚    / ê²½ë¡œ ë¼ìš°íŒ…              /api ê²½ë¡œ ë¼ìš°íŒ…                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                           â”‚
                    â–¼                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     Frontend      â”‚       â”‚         API Gateway (NestJS)          â”‚
        â”‚     Next.js       â”‚       â”‚                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚               â”‚               â”‚               â”‚               â”‚
                â–¼               â–¼               â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Faucet    â”‚ â”‚   Indexer   â”‚ â”‚   Domain    â”‚ â”‚  VC Server  â”‚ â”‚  ML Server  â”‚
        â”‚   Server    â”‚ â”‚   Server    â”‚ â”‚   Server    â”‚ â”‚             â”‚ â”‚             â”‚
        â”‚   (NestJS)  â”‚ â”‚    (Go)     â”‚ â”‚  (Spring)   â”‚ â”‚  (NestJS)   â”‚ â”‚  (FastAPI)  â”‚
        â”‚             â”‚ â”‚             â”‚ â”‚             â”‚ â”‚             â”‚ â”‚             â”‚
        â”‚   [gRPC]    â”‚ â”‚   [gRPC]    â”‚ â”‚   [HTTP]    â”‚ â”‚   [gRPC]    â”‚ â”‚   [gRPC]    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚               â”‚               â”‚               â”‚
                               â–¼               â–¼               â–¼               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ PostgreSQLâ”‚   â”‚   MySQL   â”‚   â”‚ PostgreSQLâ”‚   â”‚ PostgreSQLâ”‚
                        â”‚ (Indexer) â”‚   â”‚ (Spring)  â”‚   â”‚   (VC)    â”‚   â”‚   (ML)    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          Redis Cluster                             â”‚
        â”‚                                                                    â”‚
        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
        â”‚        â”‚  Redis (Queue)  â”‚          â”‚  Redis (Cache)  â”‚           â”‚
        â”‚        â”‚   - BullQueue   â”‚          â”‚  - Global Cache â”‚           â”‚
        â”‚        â”‚   - Job Queue   â”‚          â”‚  - Session      â”‚           â”‚
        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     Blockchain Service                             â”‚
        â”‚                                                                    â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚    â”‚                      Ingress                            â”‚     â”‚
        â”‚    â”‚          (ì™¸ë¶€ RPC ì ‘ê·¼ - ì§€ê°‘ ì„œëª…/íŠ¸ëœì­ì…˜ ì „ì†¡)          â”‚     â”‚
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                              â”‚                                    â”‚
        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚    â”‚                  Hyperledger Besu                         â”‚   â”‚
        â”‚    â”‚                                                           â”‚   â”‚
        â”‚    â”‚      Node â†â†’ Node â†â†’ Node  (Route By Service LoadBalancer)â”‚   â”‚
        â”‚    â”‚                                                           â”‚   â”‚
        â”‚    â”‚   Smart Contracts:                                        â”‚   â”‚
        â”‚    â”‚   - PetDIDRegistry                                        â”‚   â”‚
        â”‚    â”‚   - GuardianRegistry                                      â”‚   â”‚
        â”‚    â”‚   - ShelterRegistry                                       â”‚   â”‚
        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚           CI/CD Pipeline         â”‚
                              â”‚                                  â”‚
                              â”‚  SourcePipeline â†’ SourceCommit   â”‚
                              â”‚        â†“                         â”‚
                              â”‚  SourceBuild â†’ Container Registryâ”‚
                              â”‚        â†“                         â”‚
                              â”‚  SourceDeploy                    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í†µì‹  êµ¬ì¡°

| ì„œë¹„ìŠ¤ | ê¸°ìˆ  ìŠ¤íƒ | í†µì‹  í”„ë¡œí† ì½œ | ì—­í•  |
|--------|----------|--------------|------|
| **VC Server** | NestJS | gRPC (`:50055`) | Verifiable Credential ê´€ë¦¬, ì¸ì¦ ìƒíƒœ ì €ì¥ |
| **ML Server** | FastAPI | gRPC (`:50052`) | ë¹„ë¬¸ íŠ¹ì§• ë²¡í„° ì¶”ì¶œ, ìœ ì‚¬ë„ ê²€ì¦ |
| **Indexer** | Go | gRPC (`:50053`) | ë¸”ë¡ì²´ì¸ ì´ë²¤íŠ¸ ì¸ë±ì‹±, í« ì´ì „ ì´ë ¥ ì¡°íšŒ |
| **Faucet Server** | NestJS | gRPC (`:50054`) | ì‹ ê·œ ê°€ì…ì í…ŒìŠ¤íŠ¸ í† í° ì§€ê¸‰ |
| **Domain Server (Spring)** | Spring Boot | HTTP (`:8080`) | ë©”ì¸ CRUD, ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬, ê²Œì‹œë¬¼/ì±„íŒ… |

---

## ì¸ì¦ í”Œë¡œìš°

ë©ëƒ¥í¬ì˜ íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ì€ **4ë‹¨ê³„**ë¡œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤:

### 1ë‹¨ê³„: ì§€ê°‘ ì—°ê²°
```
í´ë¼ì´ì–¸íŠ¸ â†’ ì§€ê°‘(MetaMask ë“±) ì—°ê²° â†’ walletAddress íšë“
```

### 2ë‹¨ê³„: íšŒì›ê°€ì… (ì´ë©”ì¼ ì¸ì¦)
```
POST /api/email/verification/send   # ì¸ì¦ì½”ë“œ ë°œì†¡
POST /api/email/verification/verify # ì¸ì¦ì½”ë“œ í™•ì¸
POST /api/guardian/register         # ë³´í˜¸ìë¡œ íšŒì›ê°€ì…
```

### 3ë‹¨ê³„: ì§€ê°‘ ë¡œê·¸ì¸
```
POST /api/auth/challenge  # Challenge ë¬¸ìì—´ ìš”ì²­
                          # â†’ Challenge + VP ì„œëª… ë°ì´í„° ë°˜í™˜

í´ë¼ì´ì–¸íŠ¸: Challengeì™€ VP messageHashì— ì§€ê°‘ìœ¼ë¡œ ì„œëª…

POST /api/auth/login      # ì„œëª… ê²€ì¦ â†’ VP ë°œê¸‰ â†’ JWT ì„¸ì…˜ ìƒì„±
```

### 4ë‹¨ê³„: í”Œë«í¼ ì´ìš©
```
Authorization: Bearer <VP-JWT>

ëª¨ë“  API ìš”ì²­ì— VP ê¸°ë°˜ JWT í† í° ì‚¬ìš©
```

### ì¸ì¦ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ì¸ì¦ ê³„ì¸µ êµ¬ì¡°                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  [Middleware Layer]                                          â”‚
â”‚  â””â”€ Web3AuthMiddleware: ëª¨ë“  ìš”ì²­ì— JWT/Web3Token ê²€ì¦        â”‚
â”‚                                                              â”‚
â”‚  [Guard Layer]                                               â”‚
â”‚  â”œâ”€ DIDAuthGuard: DID í”Œë«í¼ ê¸°ë³¸ ì¸ì¦                        â”‚
â”‚  â”œâ”€ AdminAuthGuard: API Key ê²€ì¦ (X-Admin-Key)               â”‚
â”‚  â”œâ”€ RoleBasedGuard: ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (ADMIN/GUARDIAN/USER) â”‚
â”‚  â””â”€ SpringAuthGuard: Spring ë°±ì—”ë“œ í† í° ê²€ì¦                  â”‚
â”‚                                                              â”‚
â”‚  [Decorator Layer]                                           â”‚
â”‚  â”œâ”€ @Public(): ì¸ì¦ ìŠ¤í‚µ                                     â”‚
â”‚  â”œâ”€ @RBAC(): ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´                              â”‚
â”‚  â””â”€ @WalletAddress(): ì§€ê°‘ ì£¼ì†Œ ì¶”ì¶œ                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ë°ì´í„° ë™ê¸°í™” ì „ëµ

### SAGA íŒ¨í„´ ë¯¸ì ìš© ì´ìœ 

MSA êµ¬ì¡°ì´ì§€ë§Œ **SAGA íŒ¨í„´ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤**:
- ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ì€ **ìˆ˜ì • ë¶ˆê°€ëŠ¥(Immutable)**
- ë”°ë¼ì„œ **ë³´ìƒ íŠ¸ëœì­ì…˜(Compensating Transaction)** ë¶ˆê°€

### ë¸”ë¡ì²´ì¸ ê¸°ë°˜ ë™ê¸°í™”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ ì„±ê³µ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BullQueue (Redis)                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ blockchain  â”‚  â”‚ spring-sync â”‚  â”‚ image-move  â”‚          â”‚
â”‚  â”‚    queue    â”‚  â”‚    queue    â”‚  â”‚    queue    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë¹„ë™ê¸° ë™ê¸°í™”                    â”‚
â”‚                                                              â”‚
â”‚  VC Server â† ë¸”ë¡ì²´ì¸ ìƒíƒœ ë°˜ì˜                               â”‚
â”‚  Spring Server â† í« ë°ì´í„° ë™ê¸°í™”                             â”‚
â”‚  Indexer â† ì´ë²¤íŠ¸ ì¸ë±ì‹±                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë™ê¸°í™” ì›ì¹™

1. **ë¸”ë¡ì²´ì¸ì´ ì‹ ë¢°ì˜ ì›ì²œ**: ëª¨ë“  ì¤‘ìš”í•œ ìƒíƒœ ë³€ê²½ì€ ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ ì„±ê³µ í›„ ì²˜ë¦¬
2. **ë¹„ë™ê¸° ë™ê¸°í™”**: BullQueueë¥¼ í†µí•´ ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì— ë¹„ë™ê¸°ë¡œ ì „íŒŒ
3. **ì¬ì‹œë„ ì •ì±…**: ì§€ìˆ˜ ë°±ì˜¤í”„(Exponential Backoff)ë¡œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)

---

## ê¸°ìˆ  ìŠ¤íƒ

### Backend
- **Framework**: NestJS (Node.js)
- **Language**: TypeScript

### Blockchain
- **Network**: Hyperledger Besu
- **Library**: ethers.js v6
- **DID**: did-jwt-vc, ethr-did

### Communication
- **Internal**: gRPC (Protocol Buffers)
- **External**: HTTP/REST
- **Realtime**: WebSocket (Socket.io)

### Queue & Cache
- **Message Queue**: BullQueue
- **Cache**: Redis (ioredis)

### Infrastructure
- **Cloud**: NCloud (Naver Cloud Platform)
- **Container**: Docker
- **Orchestration**: Kubernetes (NKS)
- **Storage**: AWS S3 / NCloud Object Storage
- **CI/CD**: SourcePipeline, SourceBuild, SourceDeploy

---

## ì„¤ì¹˜ ë° ì‹¤í–‰

### ì‚¬ì „ ìš”êµ¬ì‚¬í•­

- Node.js 20+
- pnpm
- Redis
- ê° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì‹¤í–‰ (VC Server, ML Server, Indexer, Faucet, Spring)

### ì„¤ì¹˜

```bash
pnpm install
```

### ê°œë°œ ëª¨ë“œ ì‹¤í–‰

```bash
pnpm run start:dev
```

### í”„ë¡œë•ì…˜ ë¹Œë“œ ë° ì‹¤í–‰

```bash
pnpm run build
pnpm run start:prod
```

### Docker

```bash
docker build -t dogcatpaw-api-gateway .
docker run -p 3000:3000 dogcatpaw-api-gateway
```

### Kubernetes

```bash
kubectl apply -f k8s/
```

---

## API ì—”ë“œí¬ì¸íŠ¸

### Authentication
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/auth/challenge` | - | Challenge ë¬¸ìì—´ ìš”ì²­ |
| POST | `/api/auth/login` | - | ì§€ê°‘ ì„œëª…ìœ¼ë¡œ ë¡œê·¸ì¸ (VP ë°œê¸‰) |
| POST | `/api/auth/refresh` | JWT | JWT í† í° ê°±ì‹  |
| POST | `/api/auth/logout` | JWT | ë¡œê·¸ì•„ì›ƒ |

### Pet
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/pet/prepare-registration` | JWT | í« ë“±ë¡ ì¤€ë¹„ (ì„œëª… ë°ì´í„° ìƒì„±) |
| POST | `/pet/register` | JWT | í« ë“±ë¡ (ì„œëª…ëœ íŠ¸ëœì­ì…˜ ì œì¶œ) |
| GET | `/pet/:petDID` | JWT | í« ì •ë³´ ì¡°íšŒ |
| PATCH | `/pet/:petDID/transfer` | JWT | í« ë³´í˜¸ê¶Œ ì´ì „ |

### Guardian
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/guardian/prepare-registration` | - | ë³´í˜¸ì ë“±ë¡ ì¤€ë¹„ |
| POST | `/guardian/register` | - | ë³´í˜¸ì ë“±ë¡ |

### Verifiable Credentials
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/vc/:petDID` | JWT | í«ì˜ VC ì¡°íšŒ |
| GET | `/vc/wallet/:address` | JWT | ì§€ê°‘ì˜ ëª¨ë“  VC ì¡°íšŒ |

### Faucet
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/faucet/request` | JWT | í…ŒìŠ¤íŠ¸ í† í° ìš”ì²­ |
| GET | `/faucet/balance` | JWT | Faucet ì”ì•¡ ì¡°íšŒ |
| GET | `/faucet/history` | JWT | ì§€ê¸‰ ì´ë ¥ ì¡°íšŒ |

---

### Spring Backend Proxy API

Spring ë°±ì—”ë“œë¡œ í”„ë¡ì‹œë˜ëŠ” API ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤.

#### Pet Profile
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/pet` | JWT | ë‚´ í« ëª©ë¡ ì¡°íšŒ |

#### Adoption (ì…ì–‘ ê³µê³ )
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/adoption` | - | ì…ì–‘ ê³µê³  ëª©ë¡ ì¡°íšŒ (ì»¤ì„œ í˜ì´ì§€ë„¤ì´ì…˜) |
| GET | `/api/adoption/detail/:adoptId` | - | ì…ì–‘ ê³µê³  ìƒì„¸ ì¡°íšŒ |
| GET | `/api/adoption/home` | - | í™ˆ í™”ë©´ ë°ì´í„° ì¡°íšŒ |
| POST | `/api/adoption/post` | JWT | ì…ì–‘ ê³µê³  ì‘ì„± |
| PATCH | `/api/adoption/:adoptionId` | JWT | ì…ì–‘ ê³µê³  ìˆ˜ì • |
| PATCH | `/api/adoption/:adoptionId/delegate` | JWT | ì…ì–‘ ì™„ë£Œ ì²˜ë¦¬ |

#### Daily Story (ì¼ìƒ ì¼ì§€)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/story/daily` | JWT | ì¼ìƒ ì¼ì§€ ì‘ì„± |
| GET | `/api/story/daily/stories` | - | ì¼ìƒ ì¼ì§€ í”¼ë“œ ì¡°íšŒ |
| GET | `/api/story/daily/:storyId` | - | ì¼ìƒ ì¼ì§€ ìƒì„¸ ì¡°íšŒ |
| DELETE | `/api/story/daily/:storyId` | JWT | ì¼ìƒ ì¼ì§€ ì‚­ì œ |

#### Review Story (ì…ì–‘ í›„ê¸°)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/story/review` | JWT | ì…ì–‘ í›„ê¸° ì‘ì„± |
| GET | `/api/story/review/reviews` | - | ì…ì–‘ í›„ê¸° í”¼ë“œ ì¡°íšŒ |
| GET | `/api/story/review/:reviewId` | - | ì…ì–‘ í›„ê¸° ìƒì„¸ ì¡°íšŒ |
| DELETE | `/api/story/review/:storyId` | JWT | ì…ì–‘ í›„ê¸° ì‚­ì œ |

#### Like & Comment (ì¢‹ì•„ìš”/ëŒ“ê¸€)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/like` | JWT | ì¢‹ì•„ìš” í† ê¸€ (storyId ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°) |
| GET | `/api/comment` | - | ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ (storyId ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°) |
| POST | `/api/comment` | JWT | ëŒ“ê¸€ ì‘ì„± |
| DELETE | `/api/comment/:commentId` | JWT | ëŒ“ê¸€ ì‚­ì œ |

#### Chat (ì±„íŒ…)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/chat/room/create` | JWT | ì±„íŒ…ë°© ìƒì„± (ì…ì–‘ ë¬¸ì˜) |
| GET | `/api/chat/room/list` | JWT | ë‚´ ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ |
| GET | `/api/chat/room/card` | JWT | ì±„íŒ…ë°© ì¹´ë“œ ì •ë³´ ì¡°íšŒ (roomId ì¿¼ë¦¬) |
| POST | `/api/chat/:roomId/enter` | JWT | ì±„íŒ…ë°© ì…ì¥ ë° ë©”ì‹œì§€ ì´ë ¥ ì¡°íšŒ |
| GET | `/api/chat/room/:roomId/adoption` | JWT | ì±„íŒ…ë°© ê´€ë ¨ ì…ì–‘ ê³µê³  ì •ë³´ ì¡°íšŒ |

#### Chat (WebSocket Events)
| Event | Description |
|-------|-------------|
| `joinRoom` | ì±„íŒ…ë°© ì…ì¥ (ë©”ì‹œì§€ ì´ë ¥ ë°˜í™˜) |
| `sendMessage` | ë©”ì‹œì§€ ì „ì†¡ |
| `message` | ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  |
| `leaveRoom` | ì±„íŒ…ë°© í‡´ì¥ |

#### Donation (í›„ì›)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/donation/posts` | JWT | í›„ì› ìº í˜ì¸ ìƒì„± |
| GET | `/api/donation/list` | - | í›„ì› ìº í˜ì¸ ëª©ë¡ ì¡°íšŒ |
| GET | `/api/donation/:donationId` | - | í›„ì› ìº í˜ì¸ ìƒì„¸ ë° í›„ì› ì´ë ¥ ì¡°íšŒ |
| POST | `/api/donations` | JWT | ë¼ˆë‹¤ê·€(Bones)ë¡œ í›„ì›í•˜ê¸° |
| GET | `/api/donations/mine` | JWT | ë‚´ í›„ì› ì´ë ¥ ì¡°íšŒ |
| GET | `/api/donations/bone` | JWT | ë‚´ ë¼ˆë‹¤ê·€ ì”ì•¡ ì¡°íšŒ |

#### Payment (ê²°ì œ)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/payment/prepare` | JWT | ë¼ˆë‹¤ê·€ êµ¬ë§¤ ê²°ì œ ì¤€ë¹„ |
| POST | `/api/payment/approve` | JWT | ê²°ì œ ìŠ¹ì¸ ë° ë¼ˆë‹¤ê·€ ì¶©ì „ |

#### Admin (ê´€ë¦¬ì)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/admin` | JWT (ADMIN) | ì „ì²´ íšŒì› ë° í« ëª©ë¡ ì¡°íšŒ |

#### Shelter (ë³´í˜¸ì†Œ)
| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/shelter` | - | ë³´í˜¸ì†Œ ëª©ë¡ ì¡°íšŒ (ì§€ì—­/í‚¤ì›Œë“œ í•„í„°) |

---

## í™˜ê²½ ë³€ìˆ˜

```env
# Server
PORT=3000

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT
ACCESS_TOKEN_SECRET=your-access-token-secret
REFRESH_TOKEN_SECRET=your-refresh-token-secret

# Blockchain
RPC_URL=https://your-besu-rpc-url
ADMIN_PRIVATE_KEY=your-admin-private-key
GUARDIAN_REGISTRY_ADDRESS=0x...
PET_DID_REGISTRY_ADDRESS=0x...

# gRPC Services
VC_SERVICE_URL=localhost:50055
ML_SERVICE_URL=localhost:50052
INDEXER_SERVICE_URL=localhost:50053
FAUCET_SERVICE_URL=localhost:50054

# HTTP Services
SPRING_SERVER_URL=http://localhost:8080

# AWS
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_S3_BUCKET_NAME=

# Email
EMAIL_USER=
EMAIL_APP_PASSWORD=

# CORS
CORS_ORIGIN=http://localhost:3000
CORS_CREDENTIALS=true
```

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
src/
â”œâ”€â”€ abis/                  # ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ABI
â”œâ”€â”€ admin/                 # ê´€ë¦¬ì ê¸°ëŠ¥
â”œâ”€â”€ auth/                  # DID ê¸°ë°˜ ì¸ì¦ (JWT, Web3, VP)
â”œâ”€â”€ blockchain/            # ë¸”ë¡ì²´ì¸ ì‘ì—… í (BullQueue)
â”œâ”€â”€ chat/                  # WebSocket ì‹¤ì‹œê°„ ì±„íŒ…
â”œâ”€â”€ common/                # ê³µí†µ ìœ í‹¸ë¦¬í‹° (Redis, ìƒìˆ˜, ì—ëŸ¬ì½”ë“œ)
â”œâ”€â”€ email/                 # ì´ë©”ì¼ ì¸ì¦
â”œâ”€â”€ faucet/                # Faucet ì„œë¹„ìŠ¤ í”„ë¡ì‹œ (gRPC)
â”œâ”€â”€ guardian/              # ë³´í˜¸ì ê´€ë¦¬
â”œâ”€â”€ indexer/               # Indexer ì„œë¹„ìŠ¤ í”„ë¡ì‹œ (gRPC)
â”œâ”€â”€ nose-embedding/        # ML ë¹„ë¬¸ íŠ¹ì§•ë²¡í„° ì¶”ì¶œ (gRPC)
â”œâ”€â”€ pet/                   # í« ë“±ë¡ ë° ê´€ë¦¬
â”œâ”€â”€ spring/                # Spring ë°±ì—”ë“œ í”„ë¡ì‹œ (HTTP)
â”œâ”€â”€ vc/                    # Verifiable Credentials (gRPC)
â”œâ”€â”€ app.module.ts          # ë£¨íŠ¸ ëª¨ë“ˆ
â””â”€â”€ main.ts                # ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 

proto/                     # gRPC í”„ë¡œí† ì½œ ì •ì˜
â”œâ”€â”€ vc.proto
â”œâ”€â”€ faucet.proto
â”œâ”€â”€ indexer.proto
â””â”€â”€ nose_embedder.proto

k8s/                       # Kubernetes ë°°í¬ ì„¤ì •
```

---

## ë¼ì´ì„ ìŠ¤

This project is proprietary software.
